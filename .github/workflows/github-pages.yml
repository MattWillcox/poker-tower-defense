name: Deploy to GitHub Pages

on:
  push:
    branches: [main]  # Adjust this to your main branch if different
  workflow_dispatch:  # Allow manual triggering

jobs:
  deploy-to-github-pages:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up environment
      run: |
        mkdir -p docs
        mkdir -p scripts
        
        # Create the script to generate GitHub Pages content
        cat << 'EOFSCRIPT' > scripts/generate-github-pages.sh
        #!/bin/bash

        # This script generates a GitHub Pages version of the game client
        mkdir -p docs

        # Use the provided backend URL or fallback to a default
        BACKEND_URL="${1:-your-droplet-ip-or-domain.com}"

        # Generate index.html based on the game client
        if [ ! -f game-client.html ]; then
          echo "Warning: game-client.html not found. Creating a placeholder page."
          cat << 'EOFHTML' > docs/index.html
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Poker Tower Defense</title>
            <style>
                body { font-family: Arial, sans-serif; background: #f0f0f0; text-align: center; padding: 50px; }
                h1 { color: #333; }
            </style>
        </head>
        <body>
            <h1>Poker Tower Defense</h1>
            <p>The game client is being set up. Please check back later.</p>
            <p>Backend URL: <strong>$BACKEND_URL</strong></p>
        </body>
        </html>
        EOFHTML
        else
          # Copy game-client.html
          cp game-client.html docs/index.html
          sed -i "s|ws://localhost:3000|wss://$BACKEND_URL|g" docs/index.html
          sed -i "s|http://localhost:3000|https://$BACKEND_URL|g" docs/index.html
        fi

        echo "GitHub Pages version generated in docs directory with backend URL: $BACKEND_URL"
        EOFSCRIPT
        
        chmod +x scripts/generate-github-pages.sh
      
    - name: Generate GitHub Pages version
      run: |
        ./scripts/generate-github-pages.sh "${{ secrets.BACKEND_URL }}"

    - name: Deploy to GitHub Pages
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        folder: docs
        branch: gh-pages
        token: ${{ secrets.GH_PAT }}
